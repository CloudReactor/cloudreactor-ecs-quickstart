version: "3.7"

x-service-base: &service-base
  image: cloudreactor-ecs-quickstart
  build:
    context: ./  
  volumes:
    - ./src/:/home/appuser/src/
    - ./deploy/files/proc_wrapper_1.2.2.py:/home/appuser/proc_wrapper.py
    - ./deploy/files/.env.dev:/home/appuser/.env

x-dev-base: &dev-base  
  <<: *service-base
  image:  cloudreactor-ecs-quickstart-dev  
  build:
    context: ./ 
    dockerfile: Dockerfile-dev
  volumes:
    - ./src/:/home/appuser/src/
    - ./tests/:/home/appuser/tests/
    - ./deploy/files/.env.dev:/home/appuser/.env    

services:
  task_1:
    <<: *service-base
    command: python src/task_1.py

  file_io:
    <<: *service-base
    command: python src/file_io.py
    
  web_server:
    <<: *service-base
    command: flask run -p 7070 --host=0.0.0.0
    environment:
      FLASK_APP: "src/web_server.py"
    ports:
      - "7070:7070"
      
  # Not a deployed task, here for debugging your Docker build.
  shell:
    <<: *service-base
    command: bash
     
  pytest:
    <<: *dev-base

  pytest-cov:
    <<: *dev-base
    command: pytest --cov=src

  pylint:  
    <<: *dev-base
    command: pylint src

  mypy:  
    <<: *dev-base
    command: mypy src

  dev-shell:
    <<: *dev-base
    command: bash

  pip-compile:
    image: cloudreactor-pip-tools
    build:
      context: ./  
      dockerfile: tools/pip-tools/Dockerfile
    volumes:
      - ./:/work